<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Простой P2P Чат на WebRTC без Сервера</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        #chat-container {
            width: 500px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding: 10px;
        }
        #messages {
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
        }
        #messages div {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            background: #e9e9e9;
        }
        #input-container {
            display: flex;
            margin-bottom: 10px;
        }
        #message-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        #send-button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #send-button:hover {
            background: #0056b3;
        }
        #setup-container {
            margin-bottom: 10px;
        }
        #local-sdp, #remote-sdp {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
        }
        #create-offer, #set-answer, #set-offer, #create-answer {
            padding: 8px 16px;
            margin-right: 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #status {
            padding: 10px;
            color: red;
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="setup-container">
            <button id="create-offer">Создать Оффер (Инициатор)</button>
            <button id="create-answer">Создать Ответ (Ответчик)</button>
            <textarea id="local-sdp" placeholder="Ваш SDP (скопируйте отсюда)"></textarea>
            <textarea id="remote-sdp" placeholder="SDP собеседника (вставьте сюда)"></textarea>
            <button id="set-offer">Установить Оффер (Ответчик)</button>
            <button id="set-answer">Установить Ответ (Инициатор)</button>
        </div>
        <div id="messages"></div>
        <div id="input-container">
            <input type="text" id="message-input" placeholder="Введите сообщение...">
            <button id="send-button">Отправить</button>
        </div>
        <div id="status"></div>
    </div>

    <script>
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const localSdp = document.getElementById('local-sdp');
        const remoteSdp = document.getElementById('remote-sdp');
        const createOfferBtn = document.getElementById('create-offer');
        const setOfferBtn = document.getElementById('set-offer');
        const createAnswerBtn = document.getElementById('create-answer');
        const setAnswerBtn = document.getElementById('set-answer');
        const statusDiv = document.getElementById('status');

        let pc;
        let dataChannel;

        // Конфигурация ICE-серверов (STUN для публичного использования)
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // Функция добавления сообщения
        function addMessage(text, isLocal = true) {
            const msgDiv = document.createElement('div');
            msgDiv.textContent = text;
            msgDiv.style.background = isLocal ? '#d4edda' : '#e9e9e9';
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Инициализация PeerConnection
        function initPC() {
            pc = new RTCPeerConnection(config);

            pc.onicecandidate = (event) => {
                if (event.candidate === null) {
                    localSdp.value = JSON.stringify(pc.localDescription);
                }
            };

            pc.oniceconnectionstatechange = () => {
                statusDiv.textContent = `ICE state: ${pc.iceConnectionState}`;
                if (pc.iceConnectionState === 'disconnected') {
                    statusDiv.textContent = 'Соединение разорвано';
                }
            };

            pc.ondatachannel = (event) => {
                dataChannel = event.channel;
                setupDataChannel();
            };
        }

        // Настройка DataChannel
        function setupDataChannel() {
            dataChannel.onmessage = (event) => {
                addMessage(`Собеседник: ${event.data}`, false);
            };

            dataChannel.onopen = () => {
                statusDiv.textContent = 'Канал открыт! Можно отправлять сообщения.';
                sendButton.disabled = false;
            };

            dataChannel.onclose = () => {
                statusDiv.textContent = 'Канал закрыт.';
                sendButton.disabled = true;
            };
        }

        // Создание оффера (Инициатор)
        createOfferBtn.addEventListener('click', async () => {
            initPC();
            dataChannel = pc.createDataChannel('chat');
            setupDataChannel();
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            statusDiv.textContent = 'Оффер создан. Скопируйте SDP и отправьте собеседнику.';
        });

        // Установка оффера и создание ответа (Ответчик)
        setOfferBtn.addEventListener('click', async () => {
            try {
                const remoteDesc = JSON.parse(remoteSdp.value);
                await pc.setRemoteDescription(new RTCSessionDescription(remoteDesc));
                statusDiv.textContent = 'Оффер установлен.';
            } catch (err) {
                statusDiv.textContent = 'Ошибка: ' + err.message;
            }
        });

        createAnswerBtn.addEventListener('click', async () => {
            initPC();
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            statusDiv.textContent = 'Ответ создан. Скопируйте SDP и отправьте инициатору.';
        });

        // Установка ответа (Инициатор)
        setAnswerBtn.addEventListener('click', async () => {
            try {
                const remoteDesc = JSON.parse(remoteSdp.value);
                await pc.setRemoteDescription(new RTCSessionDescription(remoteDesc));
                statusDiv.textContent = 'Ответ установлен. Ожидайте соединения.';
            } catch (err) {
                statusDiv.textContent = 'Ошибка: ' + err.message;
            }
        });

        // Отправка сообщения
        sendButton.addEventListener('click', () => {
            const text = messageInput.value.trim();
            if (text && dataChannel && dataChannel.readyState === 'open') {
                dataChannel.send(text);
                addMessage(`Вы: ${text}`);
                messageInput.value = '';
            } else {
                statusDiv.textContent = 'Канал не открыт или сообщение пустое.';
            }
        });

        // Отправка по Enter
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });

        // Изначально кнопка отправки отключена
        sendButton.disabled = true;
    </script>
</body>
</html>
