<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîí –ó–ê–ö–†–´–¢–´–ô –ß–ê–¢-–ö–û–ú–ü–ê–ù–ò</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body {font-family:'Roboto',sans-serif;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);margin:0;padding:20px;height:100vh;display:flex;justify-content:center;align-items:flex-start;color:#333;}
        #chat-container {width:520px;max-width:95%;background:#fff;border-radius:20px;box-shadow:0 15px 35px rgba(0,0,0,0.15);overflow:hidden;margin-top:20px;}
        #messages {height:420px;overflow-y:auto;padding:20px;background:#f8f9fa;}
        .msg {margin-bottom:14px;padding:12px 18px;border-radius:20px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.06);max-width:85%;word-wrap:break-word;animation:fadeIn .3s;}
        .my {align-self:flex-end;background:#007bff !important;color:#fff;}
        .system {background:#e2e8f0;color:#2d3748;font-size:13px;text-align:center;margin:10px 0;padding:8px;border-radius:12px;}
        @keyframes fadeIn {from{opacity:0;transform:translateY(10px)}to{opacity:1}}

        .panel {padding:14px 16px;background:#e9f7ef;border-bottom:1px solid #c3e6cb;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;}
        .panel input, .panel button {padding:11px 14px;border-radius:12px;border:none;font-size:15px;position:relative;}
        .panel input {background:#fff;border:1px solid #ced4da;font-family:monospace;}
        #room-number {width:110px;text-align:center;}
        #max-users {width:60px;text-align:center;}
        #generate-room, #generate-key {background:#ffc107;color:#212529;cursor:pointer;}
        #enter-room, #activate-key {background:#28a745;color:#fff;cursor:pointer;font-weight:500;}
        #deactivate-key {background:#dc3545;color:#fff;display:none;}
        #activate-key.active {background:#1e7e34;}

        /* –°—Ç–∏–ª—å —Ç—É–ª—Ç–∏–ø–æ–≤ */
        [title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 100;
            opacity: 0.9;
        }
        [title]:hover::before {
            content: "";
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: #333;
            z-index: 100;
        }

        #input-container {display:flex;padding:15px;background:#f8f9fa;border-top:1px solid #e9ecef;gap:10px;align-items:center;}
        #message-input {flex:1;padding:12px;border:1px solid #ced4da;border-radius:10px;font-size:16px;}
        #send-button {position:relative;padding:12px 26px;background:#28a745;color:#fff;border:none;border-radius:10px;cursor:pointer;}
        #encryption-indicator {position:absolute;top:-10px;right:-10px;width:28px;height:28px;display:none;}
        #encryption-indicator.active {display:block;}

        #warning {background:#f8d7da;color:#721c24;padding:12px;border-radius:8px;margin:10px 16px;text-align:center;display:none;font-weight:500;}
        #status {padding:12px;text-align:center;background:#e9ecef;font-size:15px;}
    </style>
</head>
<body>

<div id="chat-container">
    <div class="panel">
        <input type="number" id="room-number" placeholder="–ù–æ–º–µ—Ä" value="921502" title="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã (6 —Ü–∏—Ñ—Ä). –ü–µ—Ä–µ–¥–∞–π—Ç–µ –µ–≥–æ —Ç–æ–ª—å–∫–æ —Ç–µ–º, –∫–æ–º—É –¥–æ–≤–µ—Ä—è–µ—Ç–µ!">
        <button id="generate-room" title="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã">üé≤ –°–ª—É—á–∞–π–Ω—ã–π</button>
        <input type="number" id="max-users" placeholder="–õ–∏–º–∏—Ç –±–µ–∑ –º–µ–Ω—è" min="1" max="20" value="1" title="–°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ (–∫—Ä–æ–º–µ –≤–∞—Å) –º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É">
        <button id="enter-room" title="–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ –ø–æ –Ω–æ–º–µ—Ä—É">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
    </div>

    <div class="panel" id="key-panel" style="display:none;background:#e8f5e9;">
        <input type="text" id="aes-key-input" placeholder="AES-256 –∫–ª—é—á (64 hex)" maxlength="64" title="–ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è AES-256. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–æ–≤–Ω–æ 64 —Å–∏–º–≤–æ–ª–∞ –≤ —à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç–µ—Ä–∏—á–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ">
        <button id="generate-key" title="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–¥—ë–∂–Ω—ã–π 256-–±–∏—Ç–Ω—ã–π –∫–ª—é—á –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º">üîë –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="activate-key" title="–í–∫–ª—é—á–∏—Ç—å end-to-end —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
        <button id="deactivate-key" title="–û—Ç–∫–ª—é—á–∏—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ (—Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ)">–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <div id="warning"></div>
    <div id="messages"></div>

    <div id="input-container" style="display:none;">
        <input type="text" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="send-button">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            <img src="Encripted.png" id="encryption-indicator" alt="üîí">
        </button>
    </div>

    <div id="status">–ì–æ—Ç–æ–≤. –ù–∞–≤–µ–¥–∏ –∫—É—Ä—Å–æ—Ä –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã ‚Äî —É–≤–∏–¥–∏—à—å –ø–æ–¥—Å–∫–∞–∑–∫–∏</div>
</div>

<script>
    const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');

    const roomInput = document.getElementById('room-number');
    const maxUsersInput = document.getElementById('max-users');
    const enterRoomBtn = document.getElementById('enter-room');
    const generateRoomBtn = document.getElementById('generate-room');
    const keyPanel = document.getElementById('key-panel');
    const aesKeyInput = document.getElementById('aes-key-input');
    const generateKeyBtn = document.getElementById('generate-key');
    const activateKeyBtn = document.getElementById('activate-key');
    const deactivateKeyBtn = document.getElementById('deactivate-key');
    const messagesDiv = document.getElementById('messages');
    const inputContainer = document.getElementById('input-container');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const statusDiv = document.getElementById('status');
    const warningDiv = document.getElementById('warning');
    const indicator = document.getElementById('encryption-indicator');

    let nickname = localStorage.getItem('chat-nickname') || '–ê–Ω–æ–Ω–∏–º_' + Math.floor(Math.random()*9999);
    localStorage.setItem('chat-nickname', nickname);

    let currentTopic = null;
    let cryptoKey = null;
    let encryptionEnabled = false;
    let maxAllowed = 0;
    let currentUsers = 0;
    let isRoomFull = false;

    generateRoomBtn.onclick = () => roomInput.value = Math.floor(100000 + Math.random() * 900000);

    enterRoomBtn.onclick = () => {
        const room = roomInput.value.trim();
        if (!room || room < 1) return alert('–£–∫–∞–∂–∏ –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã!');
        currentTopic = `rooms-${room}`;
        maxAllowed = (parseInt(maxUsersInput.value) || 1) + 1;

        client.subscribe(currentTopic);
        client.publish(currentTopic, `SYS:JOIN:${nickname}`);

        keyPanel.style.display = 'flex';
        statusDiv.textContent = `–ö–æ–º–Ω–∞—Ç–∞ #${room} ‚Ä¢ –õ–∏–º–∏—Ç: ${maxAllowed} ‚Ä¢ –ñ–¥—ë–º –∫–ª—é—á...`;
        enterRoomBtn.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
        enterRoomBtn.disabled = true;
    };

    generateKeyBtn.onclick = () => {
        const k = crypto.getRandomValues(new Uint8Array(32));
        aesKeyInput.value = Array.from(k).map(b => b.toString(16).padStart(2,'0')).join('');
    };

    activateKeyBtn.onclick = async () => {
        const hex = aesKeyInput.value.trim();
        if (!/^[0-9a-fA-F]{64}$/.test(hex)) return alert('–ö–ª—é—á ‚Äî —Ä–æ–≤–Ω–æ 64 hex —Å–∏–º–≤–æ–ª–∞!');

        cryptoKey = await crypto.subtle.importKey("raw", hexToArrayBuffer(hex), "AES-GCM", false, ["encrypt", "decrypt"]);
        encryptionEnabled = true;

        activateKeyBtn.classList.add('active');
        activateKeyBtn.textContent = '–ö–ª—é—á –∞–∫—Ç–∏–≤–µ–Ω ‚úì';
        deactivateKeyBtn.style.display = 'inline-block';
        indicator.classList.add('active');
        aesKeyInput.disabled = true;
        generateKeyBtn.disabled = true;

        inputContainer.style.display = 'flex';
        messagesDiv.style.display = 'block';
        statusDiv.textContent = `üîí –ö–æ–º–Ω–∞—Ç–∞ #${roomInput.value} ‚Ä¢ –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ ‚Ä¢ –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: 1/${maxAllowed}`;
        warningDiv.style.display = 'none';

        addSystemMessage(`üîí –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ. –¢–æ–ª—å–∫–æ —Å —ç—Ç–∏–º –∫–ª—é—á–æ–º –≤–∏–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏—è.`);
    };

    deactivateKeyBtn.onclick = () => {
        encryptionEnabled = false;
        cryptoKey = null;
        activateKeyBtn.classList.remove('active');
        activateKeyBtn.textContent = '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á';
        deactivateKeyBtn.style.display = 'none';
        indicator.classList.remove('active');
        aesKeyInput.disabled = false;
        generateKeyBtn.disabled = false;
        addSystemMessage('üîì –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ');
    };

    async function encrypt(text) {
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const data = new TextEncoder().encode(text);
        const ct = await crypto.subtle.encrypt({name: "AES-GCM", iv}, cryptoKey, data);
        const combined = new Uint8Array(iv.byteLength + ct.byteLength);
        combined.set(iv, 0);
        combined.set(new Uint8Array(ct), iv.byteLength);
        return 'ENC:' + btoa(String.fromCharCode(...combined));
    }

    async function decrypt(b64) {
        if (!b64.startsWith('ENC:')) return b64;
        try {
            const combined = Uint8Array.from(atob(b64.slice(4)), c => c.charCodeAt(0));
            const iv = combined.slice(0,12);
            const ct = combined.slice(12);
            const dec = await crypto.subtle.decrypt({name: "AES-GCM", iv}, cryptoKey, ct);
            return new TextDecoder().decode(dec);
        } catch (e) {
            return "üîí [–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ ‚Äî –Ω—É–∂–µ–Ω –∫–ª—é—á]";
        }
    }

    function hexToArrayBuffer(hex) {
        return new Uint8Array(hex.match(/.{2}/g).map(b => parseInt(b,16))).buffer;
    }

    async function send() {
        if (isRoomFull) return alert('–ö–æ–º–Ω–∞—Ç–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞!');
        const text = messageInput.value.trim();
        if (!text) return;

        const fullText = `${nickname}: ${text}`;
        const payload = encryptionEnabled ? await encrypt(fullText) : fullText;

        client.publish(currentTopic, payload);
        addMessage(fullText, true);
        messageInput.value = '';
    }
    sendButton.onclick = send;
    messageInput.onkeydown = e => { if (e.key === 'Enter') send(); };

    async function addMessage(text, isOwn = false) {
        const div = document.createElement('div');
        div.className = 'msg' + (isOwn ? ' my' : '');
        div.textContent = encryptionEnabled ? await decrypt(text) : text;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addSystemMessage(text) {
        const div = document.createElement('div');
        div.className = 'system';
        div.textContent = text;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    client.on('message', async (topic, msg) => {
        if (topic !== currentTopic) return;
        const payload = msg.toString();

        if (payload.startsWith('SYS:JOIN:')) {
            const user = payload.split(':')[2];
            currentUsers++;
            addSystemMessage(`‚Üí ${user} –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è`);
            statusDiv.textContent = `–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${currentUsers}/${maxAllowed}`;

            if (currentUsers > maxAllowed) {
                isRoomFull = true;
                warningDiv.textContent = '‚ö† –ö–æ–º–Ω–∞—Ç–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞! –ù–æ–≤—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–µ –≤–∏–¥—è—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –Ω–µ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å.';
                warningDiv.style.display = 'block';
                inputContainer.style.display = 'none';
            }
            return;
        }

        addMessage(payload);
    });

    client.on('connect', () => statusDiv.textContent += ' ‚Ä¢ MQTT –≥–æ—Ç–æ–≤');

    window.onload = () => generateRoomBtn.click();
</script>
</body>
</html>
