<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîí –ó–ê–ö–†–´–¢–´–ï –ß–ê–¢-–ö–û–ú–ü–ê–ù–ò ‚Ä¢ –†–ê–ë–û–¢–ê–ï–¢ –ù–ê 100%</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body {font-family:'Roboto',sans-serif;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);margin:0;padding:20px;height:100vh;display:flex;justify-content:center;align-items:flex-start;color:#333;}
        #chat-container {width:520px;max-width:95%;background:#fff;border-radius:20px;box-shadow:0 15px 35px rgba(0,0,0,0.15);overflow:hidden;margin-top:20px;}
        #messages {height:420px;overflow-y:auto;padding:20px;background:#f8f9fa;}
        .msg {margin-bottom:14px;padding:12px 18px;border-radius:20px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.06);max-width:85%;word-wrap:break-word;animation:fadeIn .3s;}
        .my {align-self:flex-end;background:#007bff !important;color:#fff;}
        @keyframes fadeIn {from{opacity:0;transform:translateY(10px)}to{opacity:1}}

        .panel {padding:14px 16px;background:#e9f7ef;border-bottom:1px solid #c3e6cb;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;}
        .panel input, .panel button {padding:11px 14px;border-radius:12px;border:none;font-size:15px;}
        .panel input {background:#fff;border:1px solid #ced4da;font-family:monospace;}
        #room-number {width:100px;text-align:center;}
        #max-users {width:60px;text-align:center;}
        #generate-room, #generate-key {background:#ffc107;color:#212529;cursor:pointer;}
        #enter-room, #activate-key {background:#28a745;color:#fff;cursor:pointer;font-weight:500;}
        #enter-room:hover, #activate-key:hover {background:#218838;}

        #input-container {display:flex;padding:15px;background:#f8f9fa;border-top:1px solid #e9ecef;gap:10px;align-items:center;}
        #message-input {flex:1;padding:12px;border:1px solid #ced4da;border-radius:10px;font-size:16px;}
        #send-button {position:relative;padding:12px 26px;background:#28a745;color:#fff;border:none;border-radius:10px;cursor:pointer;}
        #encryption-indicator {position:absolute;top:-10px;right:-10px;width:28px;height:28px;display:none;}
        #encryption-indicator.active {display:block;}

        #warning {background:#f8d7da;color:#721c24;padding:12px;border-radius:8px;margin:10px 16px;text-align:center;display:none;font-weight:500;}
        #status {padding:12px;text-align:center;background:#e9ecef;font-size:15px;}
    </style>
</head>
<body>

<div id="chat-container">
    <!-- –í—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É -->
    <div class="panel">
        <input type="number" id="room-number" placeholder="–ù–æ–º–µ—Ä" value="381099">
        <button id="generate-room">üé≤ –°–ª—É—á–∞–π–Ω—ã–π</button>
        <input type="number" id="max-users" placeholder="–õ–∏–º–∏—Ç –±–µ–∑ –º–µ–Ω—è" min="1" max="20" value="1">
        <button id="enter-room">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
    </div>

    <!-- –ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤ –∫–æ–º–Ω–∞—Ç—É) -->
    <div class="panel" id="key-panel" style="display:none;background:#e8f5e9;">
        <input type="text" id="aes-key-input" placeholder="AES-256 –∫–ª—é—á (64 hex)" maxlength="64">
        <button id="generate-key">üîë –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="activate-key">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
    </div>

    <div id="warning"></div>
    <div id="messages"></div>

    <div id="input-container" style="display:none;">
        <input type="text" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="send-button">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            <img src="Encripted.png" id="encryption-indicator" alt="üîí">
        </button>
    </div>

    <div id="status">–ì–æ—Ç–æ–≤. –í–≤–µ–¥–∏ –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã ‚Üí –í–æ–π—Ç–∏ ‚Üí –ö–ª—é—á ‚Üí –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</div>
</div>

<script>
    const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');

    const roomInput = document.getElementById('room-number');
    const maxUsersInput = document.getElementById('max-users');
    const enterRoomBtn = document.getElementById('enter-room');
    const generateRoomBtn = document.getElementById('generate-room');
    const keyPanel = document.getElementById('key-panel');
    const aesKeyInput = document.getElementById('aes-key-input');
    const generateKeyBtn = document.getElementById('generate-key');
    const activateKeyBtn = document.getElementById('activate-key');
    const messagesDiv = document.getElementById('messages');
    const inputContainer = document.getElementById('input-container');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const statusDiv = document.getElementById('status');
    const warningDiv = document.getElementById('warning');
    const indicator = document.getElementById('encryption-indicator');

    let nickname = localStorage.getItem('chat-nickname') || 'User_' + Math.floor(Math.random()*9999);
    localStorage.setItem('chat-nickname', nickname);

    let currentTopic = null;
    let cryptoKey = null;
    let encryptionEnabled = false;
    let maxAllowed = 0;
    let currentUsers = 0;
    let isRoomFull = false;
    let iAmCreator = false;

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –∫–æ–º–Ω–∞—Ç—ã
    generateRoomBtn.onclick = () => roomInput.value = Math.floor(100000 + Math.random() * 900000);

    // –í—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É
    enterRoomBtn.onclick = () => {
        const room = roomInput.value.trim();
        if (!room || room < 1 || room > 999999) return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã!');
        
        currentTopic = `greambal8-room-${room}`;
        maxAllowed = (parseInt(maxUsersInput.value) || 1) + 1; // + —Ç—ã —Å–∞–º

        client.subscribe(currentTopic);
        client.publish(currentTopic, `SYS:JOIN:${nickname}`);

        keyPanel.style.display = 'flex';
        statusDiv.textContent = `–ö–æ–º–Ω–∞—Ç–∞ #${room} ‚Ä¢ –õ–∏–º–∏—Ç: ${maxAllowed} —á–µ–ª–æ–≤–µ–∫ ‚Ä¢ –ñ–¥—ë–º –∫–ª—é—á...`;
        enterRoomBtn.disabled = true;
        enterRoomBtn.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
        iAmCreator = true; // –ø–µ—Ä–≤—ã–π –∑–∞—à–µ–¥—à–∏–π ‚Äî —Ö–æ–∑—è–∏–Ω
    };

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞
    generateKeyBtn.onclick = () => {
        const k = crypto.getRandomValues(new Uint8Array(32));
        aesKeyInput.value = Array.from(k).map(b => b.toString(16).padStart(2,'0')).join('');
    };

    // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–ª—é—á–∞
    activateKeyBtn.onclick = async () => {
        const hex = aesKeyInput.value.trim();
        if (!/^[0-9a-fA-F]{64}$/.test(hex)) return alert('–ö–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–æ–≤–Ω–æ 64 hex —Å–∏–º–≤–æ–ª–∞!');

        cryptoKey = await crypto.subtle.importKey("raw", hexToArrayBuffer(hex), "AES-GCM", false, ["encrypt", "decrypt"]);
        encryptionEnabled = true;

        activateKeyBtn.textContent = '–ö–ª—é—á –∞–∫—Ç–∏–≤–µ–Ω ‚úì';
        activateKeyBtn.disabled = true;
        aesKeyInput.disabled = true;
        generateKeyBtn.disabled = true;
        indicator.classList.add('active');

        inputContainer.style.display = 'flex';
        messagesDiv.style.display = 'block';
        statusDiv.textContent = `üîí –ö–æ–º–Ω–∞—Ç–∞ #${roomInput.value} ‚Ä¢ –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ ‚Ä¢ –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: 1/${maxAllowed}`;
        warningDiv.style.display = 'none';

        addMessage(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${nickname}! –¢—ã –≤ –∑–∞–∫—Ä—ã—Ç–æ–π –∫–æ–º–Ω–∞—Ç–µ. –¢–æ–ª—å–∫–æ —Å —ç—Ç–∏–º –∫–ª—é—á–æ–º –≤–∏–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏—è.`, true);
    };

    // –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ/–¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
    async function encrypt(text) {
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const data = new TextEncoder().encode(text);
        const ct = await crypto.subtle.encrypt({name: "AES-GCM", iv}, cryptoKey, data);
        const combined = new Uint8Array(iv.byteLength + ct.byteLength);
        combined.set(iv, 0);
        combined.set(new Uint8Array(ct), iv.byteLength);
        return 'ENC:' + btoa(String.fromCharCode(...combined));
    }

    async function decrypt(b64) {
        if (!b64.startsWith('ENC:')) return b64;
        try {
            const combined = Uint8Array.from(atob(b64.slice(4)), c => c.charCodeAt(0));
            const iv = combined.slice(0,12);
            const ct = combined.slice(12);
            const dec = await crypto.subtle.decrypt({name: "AES-GCM", iv}, cryptoKey, ct);
            return new TextDecoder().decode(dec);
        } catch (e) {
            return "üîí –°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ ‚Äî –Ω—É–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á";
        }
    }

    function hexToArrayBuffer(hex) {
        return new Uint8Array(hex.match(/.{2}/g).map(b => parseInt(b,16))).buffer;
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞
    async function send() {
        if (isRoomFull) return;
        const text = messageInput.value.trim();
        if (!text) return;
        const payload = encryptionEnabled ? await encrypt(`${nickname}: ${text}`) : `${nickname}: ${text}`;
        client.publish(currentTopic, payload);
        addMessage(`${nickname}: ${text}`, true);
        messageInput.value = '';
    }
    sendButton.onclick = send;
    messageInput.onkeydown = e => { if (e.key === 'Enter') send(); };

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    async function addMessage(text, isOwn = false) {
        const div = document.createElement('div');
        div.className = 'msg' + (isOwn ? ' my' : '');
        div.textContent = encryptionEnabled ? await decrypt(text) : text;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // –ü—Ä–∏—ë–º —Å–æ–æ–±—â–µ–Ω–∏–π
    client.on('message', async (topic, msg) => {
        if (topic !== currentTopic) return;
        const payload = msg.toString();

        if (payload.startsWith('SYS:JOIN:')) {
            currentUsers++;
            if (currentUsers > maxAllowed) {
                isRoomFull = true;
                warningDiv.textContent = `‚ö† –ö–æ–º–Ω–∞—Ç–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞! –ù–æ–≤—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ù–ï –í–ò–î–Ø–¢ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –Ω–µ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å!`;
                warningDiv.style.display = 'block';
                inputContainer.style.display = 'none';
            }
            statusDiv.textContent = `–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${currentUsers}/${maxAllowed}${isRoomFull ? ' (–ø–æ–ª–Ω–æ!)' : ''}`;
            return;
        }

        if (!encryptionEnabled) {
            addMessage(payload);
        } else {
            if (payload.startsWith('ENC:')) {
                addMessage(payload);
            }
        }
    });

    client.on('connect', () => {
        statusDiv.textContent += ' ‚Ä¢ MQTT –ø–æ–¥–∫–ª—é—á—ë–Ω';
    });

    // –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç
    window.onload = () => generateRoomBtn.click();
</script>
</body>
</html>
