<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê –ó–∞—â–∏—â—ë–Ω–Ω—ã–π –ß–∞—Ç —Å E2E —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º AES-256</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 20px;
            height: 100vh;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        #chat-container {
            width: 480px;
            max-width: 95%;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            margin-top: 20px;
        }
        #messages {
            height: 420px;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .msg {
            margin-bottom: 14px;
            padding: 12px 18px;
            border-radius: 20px;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }
        .my { align-self: flex-end; background: #007bff !important; color: white; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }

        /* –ü–∞–Ω–µ–ª—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è */
        #encryption-panel {
            padding: 12px 15px;
            background: #e9f7ef;
            border-bottom: 1px solid #c3e6cb;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        #encryption-panel input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 10px;
            font-family: monospace;
        }
        #encryption-panel button {
            padding: 10px 14px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
        }
        #use-key { background: #28a745; color: white; }
        #use-key.active { background: #1e7e34; }
        #deactivate-key { background: #dc3545; color: white; }
        #generate-key { background: #ffc107; color: #212529; }

        /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ */
        #input-container {
            display: flex;
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            align-items: center;
            gap: 10px;
        }
        #message-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 10px;
            font-size: 16px;
        }
        #send-button {
            padding: 12px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            position: relative;
        }
        #encryption-indicator {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            display: none;
        }
        #encryption-indicator.active {
            display: block;
        }

        #clear-button {
            margin: 0 15px 15px;
            padding: 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
        #status {
            padding: 10px;
            text-align: center;
            background: #e9ecef;
            font-size: 14px;
        }
        .encrypted-note {
            font-size: 11px;
            color: #28a745;
            text-align: center;
            padding: 4px;
            background: rgba(40,167,69,0.1);
        }
    </style>
</head>
<body>

<div id="chat-container">
    <div id="encryption-panel">
        <input type="text" id="aes-key-input" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ AES-256 –∫–ª—é—á (64 hex —Å–∏–º–≤–æ–ª–∞)" maxlength="64">
        <button id="use-key">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á</button>
        <button id="deactivate-key" style="display:none;">–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
        <button id="generate-key">üîë –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
    </div>

    <div id="messages"></div>

    <div id="input-container">
        <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="send-button">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            <img src="Encripted.png" id="encryption-indicator" alt="üîí">
        </button>
    </div>

    <button id="clear-button">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
    <div id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
</div>

<script>
    const topic = 'greambal8-secure-chat-v2';
    const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');
    
    const messagesDiv     = document.getElementById('messages');
    const messageInput     = document.getElementById('message-input');
    const sendButton       = document.getElementById('send-button');
    const clearButton      = document.getElementById('clear-button');
    const statusDiv        = document.getElementById('status');
    const aesKeyInput      = document.getElementById('aes-key-input');
    const useKeyBtn        = document.getElementById('use-key');
    const deactivateKeyBtn = document.getElementById('deactivate-key');
    const generateKeyBtn   = document.getElementById('generate-key');
    const indicator        = document.getElementById('encryption-indicator');

    let nickname = localStorage.getItem('chat-nickname') || '–ê–Ω–æ–Ω–∏–º_' + Math.floor(Math.random()*9999);
    localStorage.setItem('chat-nickname', nickname);

    let encryptionEnabled = false;
    let aesKey = null; // CryptoJS.lib.WordArray

    // ====================== AES-256-GCM —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ ======================
    function encryptMessage(message) {
        if (!encryptionEnabled) return message;

        const iv = CryptoJS.lib.WordArray.random(12); // 96-bit IV –¥–ª—è GCM
        const encrypted = CryptoJS.AES.encrypt(message, aesKey, {
            iv: iv,
            mode: CryptoJS.mode.GCM,
            padding: CryptoJS.pad.NoPadding
        });

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º IV || ciphertext || authTag (–≤—Å–µ –≤ base64)
        const ivHex       = iv.toString();
        const ctHex       = encrypted.ciphertext.toString();
        const tagHex      = encrypted.ciphertext.toString(CryptoJS.enc.Hex).slice(-32); // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 16 –±–∞–π—Ç ‚Äî —Ç–µ–≥
        const combined    = ivHex + ctHex;
        return 'ENC:' + CryptoJS.enc.Hex.parse(combined + tagHex).toString(CryptoJS.enc.Base64);
    }

    function decryptMessage(encryptedBase64) {
        if (!encryptionEnabled || !encryptedBase64.startsWith('ENC:')) return encryptedBase64;

        try {
            const data = CryptoJS.enc.Base64.parse(encryptedBase64.slice(4));
            const hex  = data.toString(CryptoJS.enc.Hex);

            const iv       = CryptoJS.enc.Hex.parse(hex.slice(0, 24));        // 12 –±–∞–π—Ç = 24 hex
            const tag      = CryptoJS.enc.Hex.parse(hex.slice(-32));          // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 16 –±–∞–π—Ç
            const ciphertext = CryptoJS.enc.Hex.parse(hex.slice(24, -32));

            const decrypted = CryptoJS.AES.decrypt(
                { ciphertext: ciphertext },
                aesKey,
                {
                    iv: iv,
                    mode: CryptoJS.mode.GCM,
                    padding: CryptoJS.pad.NoPadding
                }
            );

            // GCM —Å–∞–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–≥, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Äî –±—Ä–æ—Å–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
            return decrypted.toString(CryptoJS.enc.Utf8);
        } catch (e) {
            return "üîì [–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ]";
        }
    }

    // ====================== –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ ======================
    generateKeyBtn.addEventListener('click', () => {
        const key = CryptoJS.lib.WordArray.random(32); // 256 –±–∏—Ç
        const keyHex = key.toString();
        aesKeyInput.value = keyHex;
        alert('–ù–æ–≤—ã–π AES-256 –∫–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ –≤—Å—Ç–∞–≤–ª–µ–Ω –≤ –ø–æ–ª–µ!\n–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ –∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –∫–∞–Ω–∞–ª–æ–º.');
    });

    // ====================== –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–ª—é—á–∞ ======================
    useKeyBtn.addEventListener('click', () => {
        const keyHex = aesKeyInput.value.trim();
        if (keyHex.length !== 64 || !/^[0-9a-fA-F]+$/.test(keyHex)) {
            alert('–û—à–∏–±–∫–∞: –∫–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–æ–≤–Ω–æ 64 hex-—Å–∏–º–≤–æ–ª–∞ (256 –±–∏—Ç)!');
            return;
        }
        aesKey = CryptoJS.enc.Hex.parse(keyHex);
        encryptionEnabled = true;

        useKeyBtn.classList.add('active');
        useKeyBtn.textContent = '–ö–ª—é—á –∞–∫—Ç–∏–≤–µ–Ω';
        deactivateKeyBtn.style.display = 'inline-block';
        indicator.classList.add('active');
        statusDiv.textContent = 'üîí –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ (AES-256-GCM)';
        statusDiv.style.color = '#28a745';
    });

    deactivateKeyBtn.addEventListener('click', () => {
        encryptionEnabled = false;
        aesKey = null;
        useKeyBtn.classList.remove('active');
        useKeyBtn.textContent = '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á';
        deactivateKeyBtn.style.display = 'none';
        indicator.classList.remove('active');
        statusDiv.textContent = '–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ';
        statusDiv.style.color = '#6c757d';
    });

    // ====================== –û—Ç–ø—Ä–∞–≤–∫–∞ ======================
    function sendMessage() {
        const text = messageInput.value.trim();
        if (!text) return;

        const fullMessage = `${nickname}: ${text}`;
        const payload = encryptMessage(fullMessage);

        client.publish(topic, payload);
        addMessage(fullMessage, true);
        messageInput.value = '';
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') sendMessage();
    });

    // ====================== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç ======================
    function addMessage(text, isOwn = false) {
        const div = document.createElement('div');
        div.className = 'msg' + (isOwn ? ' my' : '');

        // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ, –Ω–æ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ ‚Äî –ø–æ–∫–∞–∂–µ–º –∫–∞–∫ –µ—Å—Ç—å
        const decrypted = decryptMessage(text);
        div.textContent = decrypted;

        if (text.startsWith('ENC:') && encryptionEnabled) {
            div.style.background = isOwn ? '#0056b3' : '#e2f0d9';
        }

        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // ====================== MQTT ======================
    client.on('connect', () => {
        statusDiv.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ! –ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å.';
        statusDiv.style.color = '#28a745';
        client.subscribe(topic);
    });

    client.on('message', (receivedTopic, message) => {
        if (receivedTopic.toString() === topic) {
            const payload = message.toString();
            addMessage(payload, false);
        }
    });

    client.on('error', err => {
        statusDiv.textContent = '–û—à–∏–±–∫–∞ MQTT: ' + err;
        statusDiv.style.color = '#dc3545';
    });

    // –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞
    clearButton.addEventListener('click', () => {
        if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —á–∞—Ç?')) {
            messagesDiv.innerHTML = '';
            statusDiv.textContent = '–ß–∞—Ç –æ—á–∏—â–µ–Ω';
        }
    });

    // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    window.onload = () => {
        addMessage(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${nickname}! –ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —á–∞—Ç ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ AES-256 –∫–ª—é—á –∏ –Ω–∞–∂–º–∏—Ç–µ "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á".`);
    };
</script>
</body>
</html>
