<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîí –ó–∞—â–∏—â—ë–Ω–Ω—ã–π –ß–∞—Ç ‚Ä¢ AES-256-GCM ‚Ä¢ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–π</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <!-- –°–∞–º–∞—è —Å–≤–µ–∂–∞—è –∏ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è CryptoJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        body {font-family:'Roboto',sans-serif;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);margin:0;padding:20px;height:100vh;display:flex;justify-content:center;align-items:flex-start;color:#333;}
        #chat-container {width:480px;max-width:95%;background:#fff;border-radius:20px;box-shadow:0 15px 35px rgba(0,0,0,0.15);overflow:hidden;margin-top:20px;}
        #messages {height:420px;overflow-y:auto;padding:20px;background:#f8f9fa;}
        .msg {margin-bottom:14px;padding:12px 18px;border-radius:20px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.06);max-width:85%;word-wrap:break-word;animation:fadeIn .3s ease;}
        .my {align-self:flex-end;background:#007bff !important;color:#fff;}
        @keyframes fadeIn {from{opacity:0;transform:translateY(10px)}to{opacity:1}}

        #encryption-panel {padding:12px 15px;background:#e9f7ef;border-bottom:1px solid #c3e6cb;display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
        #encryption-panel input {flex:1;min-width:200px;padding:10px;border:1px solid #ced4da;border-radius:10px;font-family:monospace;}
        #encryption-panel button {padding:10px 16px;border:none;border-radius:10px;cursor:pointer;font-weight:500;}
        #use-key {background:#28a745;color:#fff;}
        #use-key.active {background:#1e7e34;}
        #deactivate-key {background:#dc3545;color:#fff;}
        #generate-key {background:#ffc107;color:#212529;}

        #input-container {display:flex;padding:15px;background:#f8f9fa;border-top:1px solid #e9ecef;gap:10px;align-items:center;}
        #message-input {flex:1;padding:12px;border:1px solid #ced4da;border-radius:10px;font-size:16px;}
        #send-button {position:relative;padding:12px 24px;background:#28a745;color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:500;}
        #encryption-indicator {position:absolute;top:-10px;right:-10px;width:28px;height:28px;display:none;}
        #encryption-indicator.active {display:block;}

        #clear-button {margin:0 15px 15px;padding:12px;background:#dc3545;color:#fff;border:none;border-radius:10px;cursor:pointer;}
        #status {padding:10px;text-align:center;background:#e9ecef;font-size:14px;}
    </style>
</head>
<body>

<div id="chat-container">
    <div id="encryption-panel">
        <input type="text" id="aes-key-input" placeholder="AES-256 –∫–ª—é—á (64 hex —Å–∏–º–≤–æ–ª–∞)" maxlength="64">
        <button id="use-key">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á</button>
        <button id="deactivate-key" style="display:none">–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="generate-key">üîë –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <div id="messages"></div>

    <div id="input-container">
        <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="send-button">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            <img src="Encripted.png" id="encryption-indicator" alt="üîí">
        </button>
    </div>

    <button id="clear-button">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
    <div id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
</div>

<script>
    const topic = 'greambal8-secure-chat-v3';
    const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');

    const messagesDiv      = document.getElementById('messages');
    const messageInput     = document.getElementById('message-input');
    const sendButton       = document.getElementById('send-button');
    const statusDiv        = document.getElementById('status');
    const aesKeyInput      = document.getElementById('aes-key-input');
    const useKeyBtn        = document.getElementById('use-key');
    const deactivateKeyBtn = document.getElementById('deactivate-key');
    const generateKeyBtn   = document.getElementById('generate-key');
    const indicator        = document.getElementById('encryption-indicator');

    let nickname = localStorage.getItem('chat-nickname') || 'User_' + Math.floor(Math.random()*9999);
    localStorage.setItem('chat-nickname', nickname);

    let encryptionEnabled = false;
    let aesKey = null; // WordArray 256 –±–∏—Ç

    // ====================== –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ AES-256-GCM —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ ======================
    function encryptMessage(message) {
        if (!encryptionEnabled) return message;

        const iv = CryptoJS.lib.WordArray.random(12); // 96-bit IV
        const encrypted = CryptoJS.AES.encrypt(message, aesKey, {
            iv: iv,
            mode: CryptoJS.mode.GCM,
            padding: CryptoJS.pad.NoPadding
        });

        // –°–æ–µ–¥–∏–Ω—è–µ–º IV + ciphertext + authTag
        const ivHex = iv.toString(CryptoJS.enc.Hex);
        const ctHex = encrypted.ciphertext.toString(CryptoJS.enc.Hex);
        const tagHex = encrypted.ciphertext.toString(CryptoJS.enc.Hex).slice(-32); // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 16 –±–∞–π—Ç —Ç–µ–≥
        const combinedHex = ivHex + ctHex + tagHex.slice(-32); // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –µ—â—ë —Ä–∞–∑

        // –õ—É—á—à–µ —Ç–∞–∫ ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± CryptoJS 4.x:
        const combined = iv.clone().concat(encrypted.ciphertext).concat(encrypted.ciphertext.clone().words.slice(-4)); // –Ω–µ –±—É–¥–µ–º —Ä–∏—Å–∫–æ–≤–∞—Ç—å
        // –°–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–±:
        return 'ENC:' + btoa(String.fromCharCode(...new Uint8Array(
            iv.concat(encrypted.ciphertext).concat(
                CryptoJS.enc.Hex.parse(encrypted.ciphertext.toString(CryptoJS.enc.Hex).slice(-32))
            ).toString(CryptoJS.enc.Latin1).split('').map(c => c.charCodeAt(0))
        )));
    }

    // –†–∞–±–æ—á–∞—è –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤—ã–≤–æ–¥ CryptoJS)
    function encryptMessage(message) {
        if (!encryptionEnabled) return message;

        const iv = CryptoJS.lib.WordArray.random(12);
        const encrypted = CryptoJS.AES.encrypt(message, aesKey, { iv: iv, mode: CryptoJS.mode.GCM });
        
        // –§–æ—Ä–º–∞—Ç: ENC:base64(iv + ciphertext + tag)
        const combined = iv.clone().concat(encrypted.ciphertext);
        // –¢–µ–≥ —É–∂–µ –≤–∫–ª—é—á—ë–Ω –≤ ciphertext –≤ CryptoJS 4.x –ø—Ä–∏ GCM
        return 'ENC:' + combined.toString(CryptoJS.enc.Base64);
    }

    function decryptMessage(data) {
        if (!encryptionEnabled || !data.startsWith('ENC:')) return data;

        try {
            const encryptedBase64 = data.slice(4);
            const encryptedData = CryptoJS.enc.Base64.parse(encryptedBase64);

            // –ü–µ—Ä–≤—ã–µ 12 –±–∞–π—Ç ‚Äî IV
            const iv = CryptoJS.lib.WordArray.create(encryptedData.words.slice(0, 3), 12);
            const ciphertext = CryptoJS.lib.WordArray.create(encryptedData.words.slice(3), encryptedData.sigBytes - 12);

            const decrypted = CryptoJS.AES.decrypt(
                { ciphertext: ciphertext },
                aesKey,
                { iv: iv, mode: CryptoJS.mode.GCM }
            );

            return decrypted.toString(CryptoJS.enc.Utf8);
        } catch (e) {
            return "üîì [–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ ‚Äî –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ]";
        }
    }

    // ====================== –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ ======================
    generateKeyBtn.onclick = () => {
        const key = CryptoJS.lib.WordArray.random(32);
        aesKeyInput.value = key.toString(CryptoJS.enc.Hex);
        alert('–ö–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω! –°–∫–æ–ø–∏—Ä—É–π –∏ –ø–µ—Ä–µ–¥–∞–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É.');
    };

    // ====================== –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–ª—é—á–∞ ======================
    useKeyBtn.onclick = () => {
        const hex = aesKeyInput.value.trim();
        if (!/^[0-9a-fA-F]{64}$/.test(hex)) {
            alert('–ö–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–æ–≤–Ω–æ 64 hex-—Å–∏–º–≤–æ–ª–∞!');
            return;
        }
        aesKey = CryptoJS.enc.Hex.parse(hex);
        encryptionEnabled = true;

        useKeyBtn.classList.add('active');
        useKeyBtn.textContent = '–ö–ª—é—á –∞–∫—Ç–∏–≤–µ–Ω ‚úì';
        deactivateKeyBtn.style.display = 'inline-block';
        indicator.classList.add('active');
        statusDiv.textContent = 'üîí –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ AES-256-GCM –≤–∫–ª—é—á–µ–Ω–æ';
        statusDiv.style.color = '#28a745';
    };

    deactivateKeyBtn.onclick = () => {
        encryptionEnabled = false;
        aesKey = null;
        useKeyBtn.classList.remove('active');
        useKeyBtn.textContent = '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á';
        deactivateKeyBtn.style.display = 'none';
        indicator.classList.remove('active');
        statusDiv.textContent = '–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ';
        statusDiv.style.color = '#6c757d';
    };

    // ====================== –û—Ç–ø—Ä–∞–≤–∫–∞ ======================
    function sendMessage() {
        const text = messageInput.value.trim();
        if (!text) return;

        const full = `${nickname}: ${text}`;
        const payload = encryptionEnabled ? encryptMessage(full) : full;

        client.publish(topic, payload);
        addMessage(full, true);
        messageInput.value = '';
    }

    sendButton.onclick = sendMessage;
    messageInput.onkeydown = e => { if (e.key === 'Enter') sendMessage(); };

    // ====================== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è ======================
    function addMessage(text, isOwn = false) {
        const div = document.createElement('div');
        div.className = 'msg' + (isOwn ? ' my' : '');
        div.textContent = decryptMessage(text);

        if (text.startsWith('ENC:')) {
            div.style.borderLeft = '4px solid #28a745';
            div.style.background = isOwn ? '#0056b3' : '#e8f5e9';
        }

        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // ====================== MQTT ======================
    client.on('connect', () => {
        statusDiv.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ! –ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å.';
        statusDiv.style.color = '#28a745';
        client.subscribe(topic);
    });

    client.on('message', (_, msg) => {
        addMessage(msg.toString());
    });

    // –û—á–∏—Å—Ç–∫–∞
    document.getElementById('clear-button').onclick = () => {
        if (confirm('–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç?')) messagesDiv.innerHTML = '';
    };

    // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    window.onload = () => {
        addMessage(`–ü—Ä–∏–≤–µ—Ç, ${nickname}! –ß–∞—Ç –≥–æ—Ç–æ–≤. –î–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –≤—Å—Ç–∞–≤—å –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫–ª—é—á ‚Üí "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á".`);
    };
</script>
</body>
</html>
