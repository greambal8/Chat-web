<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîí –ó–ê–ö–†–´–¢–´–ï –ß–ê–¢-–ö–û–ú–ü–ê–ù–ò ‚Ä¢ –ü–æ–ª–Ω–∞—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body {font-family:'Roboto',sans-serif;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);margin:0;padding:20px;height:100vh;display:flex;justify-content:center;align-items:flex-start;color:#333;}
        #chat-container {width:520px;max-width:95%;background:#fff;border-radius:20px;box-shadow:0 15px 35px rgba(0,0,0,0.15);overflow:hidden;margin-top:20px;}
        #messages {height:420px;overflow-y:auto;padding:20px;background:#f8f9fa;display:none;}
        .msg {margin-bottom:14px;padding:12px 18px;border-radius:20px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.06);max-width:85%;word-wrap:break-word;animation:fadeIn .3s;}
        .my {align-self:flex-end;background:#007bff !important;color:#fff;}
        @keyframes fadeIn {from{opacity:0;transform:translateY(10px)}to{opacity:1}}

        .panel {padding:14px 16px;background:#e9f7ef;border-bottom:1px solid #c3e6cb;display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
        .panel input {padding:10px;border:1px solid #ced4da;border-radius:10px;font-family:monospace;}
        .panel button {padding:10px 18px;border:none;border-radius:10px;cursor:pointer;font-weight:500;}
        #enter-room {background:#28a745;color:#fff;}
        #generate-room, #generate-key {background:#ffc107;color:#212529;}
        #use-key {background:#28a745;color:#fff;}
        #use-key.active {background:#1e7e34;}

        #input-container {display:flex;padding:15px;background:#f8f9fa;border-top:1px solid #e9ecef;gap:10px;align-items:center;display:none;}
        #message-input {flex:1;padding:12px;border:1px solid #ced4da;border-radius:10px;font-size:16px;}
        #send-button {position:relative;padding:12px 26px;background:#28a745;color:#fff;border:none;border-radius:10px;cursor:pointer;}
        #encryption-indicator {position:absolute;top:-10px;right:-10px;width:28px;height:28px;display:none;}
        #encryption-indicator.active {display:block;}

        #status {padding:12px;text-align:center;background:#e9ecef;font-size:15px;}
        #warning {background:#fff3cd;color:#856404;padding:12px;border-radius:8px;margin:10px 16px;text-align:center;display:none;}
    </style>
</head>
<body>

<div id="chat-container">
    <div class="panel">
        <input type="number" id="room-number" placeholder="–ù–æ–º–µ—Ä –ß–ê–¢-–ö–û–ú–ü–ê–ù–ò" min="1" max="999999">
        <button id="generate-room">üé≤ –°–ª—É—á–∞–π–Ω—ã–π</button>
        <input type="number" id="max-users" placeholder="–°–∫–æ–ª—å–∫–æ –∂–¥—ë–º (–±–µ–∑ —Å–µ–±—è)" min="1" max="50" value="1">
        <button id="enter-room">–°–æ–∑–¥–∞—Ç—å / –í–æ–π—Ç–∏</button>
    </div>

    <div class="panel" id="key-panel" style="display:none;background:#e8f5e9;">
        <input type="text" id="aes-key-input" placeholder="AES-256 –∫–ª—é—á (64 hex)" maxlength="64">
        <button id="generate-key">üîë –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="use-key">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á –∏ –≤–æ–π—Ç–∏</button>
    </div>

    <div id="warning"></div>
    <div id="messages"></div>

    <div id="input-container">
        <input type="text" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="send-button">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            <img src="Encripted.png" id="encryption-indicator" alt="üîí">
        </button>
    </div>

    <div id="status">–£–∫–∞–∂–∏ –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã ‚Üí –∫–ª—é—á ‚Üí –∏ —Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ —É–≤–∏–¥—è—Ç —á–∞—Ç</div>
</div>

<script>
    const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');

    const roomInput = document.getElementById('room-number');
    const maxUsersInput = document.getElementById('max-users');
    const generateRoomBtn = document.getElementById('generate-room');
    const enterRoomBtn = document.getElementById('enter-room');
    const keyPanel = document.getElementById('key-panel');
    const aesKeyInput = document.getElementById('aes-key-input');
    const generateKeyBtn = document.getElementById('generate-key');
    const useKeyBtn = document.getElementById('use-key');
    const messagesDiv = document.getElementById('messages');
    const inputContainer = document.getElementById('input-container');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const statusDiv = document.getElementById('status');
    const warningDiv = document.getElementById('warning');
    const indicator = document.getElementById('encryption-indicator');

    let nickname = localStorage.getItem('chat-nickname') || 'User_' + Math.floor(Math.random()*9999);
    localStorage.setItem('chat-nickname', nickname);

    let currentTopic = null;
    let cryptoKey = null;
    let maxAllowed = 0;
    let participantCount = 0;

    // –•—ç—à –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–ø–∏–∫–∞ (SHA-256 –æ—Ç "roomnumber+saltedkey")
    async function deriveTopic(room, hexKey) {
        const data = new TextEncoder().encode(`greambal8-secret-room-${room}-${hexKey}`);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashHex = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,'0')).join('');
        return `private/${hashHex}`;
    }

    // Web Crypto AES-256-GCM
    async function importKey(hex) {
        const raw = hexToArrayBuffer(hex);
        return await crypto.subtle.importKey("raw", raw, "AES-GCM", false, ["encrypt", "decrypt"]);
    }

    async function encrypt(msg) {
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const data = new TextEncoder().encode(msg);
        const ct = await crypto.subtle.encrypt({name:"AES-GCM", iv}, cryptoKey, data);
        const combined = new Uint8Array(iv.byteLength + ct.byteLength);
        combined.set(iv, 0);
        combined.set(new Uint8Array(ct), iv.byteLength);
        return 'ENC:' + btoa(String.fromCharCode(...combined));
    }

    async function decrypt(b64) {
        try {
            const combined = Uint8Array.from(atob(b64.slice(4)), c => c.charCodeAt(0));
            const iv = combined.slice(0,12);
            const ct = combined.slice(12);
            const dec = await crypto.subtle.decrypt({name:"AES-GCM", iv}, cryptoKey, ct);
            return new TextDecoder().decode(dec);
        } catch(e) { return "[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ ‚Äî –Ω—É–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á]"; }
    }

    function hexToArrayBuffer(h) { return new Uint8Array(h.match(/.{2}/g).map(b=>parseInt(b,16))).buffer; }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–º–Ω–∞—Ç—ã
    generateRoomBtn.onclick = () => roomInput.value = Math.floor(100000 + Math.random()*900000);

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞
    generateKeyBtn.onclick = async () => {
        const k = crypto.getRandomValues(new Uint8Array(32));
        aesKeyInput.value = Array.from(k).map(b=>b.toString(16).padStart(2,'0')).join('');
    };

    // –ì–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ ‚Äî –∞–∫—Ç–∏–≤–∞—Ü–∏—è –∫–ª—é—á–∞ –∏ –≤—Ö–æ–¥
    useKeyBtn.onclick = async () => {
        const room = roomInput.value.trim();
        const hex = aesKeyInput.value.trim();
        if (!room || !/^[0-9]{1,6}$/.test(room)) return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã');
        if (!/^[0-9a-fA-F]{64}$/.test(hex)) return alert('–ö–ª—é—á ‚Äî —Ä–æ–≤–Ω–æ 64 hex —Å–∏–º–≤–æ–ª–∞!');

        maxAllowed = (parseInt(maxUsersInput.value) || 1) + 1;

        cryptoKey = await importKey(hex);
        currentTopic = await deriveTopic(room, hex);

        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–ø–∏–∫
        client.subscribe(currentTopic);

        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (—Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
        client.publish(currentTopic, `JOIN:${nickname}:${Date.now()}`);

        keyPanel.style.display = 'none';
        messagesDiv.style.display = 'block';
        inputContainer.style.display = 'flex';
        statusDiv.textContent = `–ß–ê–¢-–ö–û–ú–ü–ê–ù–ò #${room} ‚Ä¢ –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: 1/${maxAllowed} ‚Ä¢ –ü–æ–ª–Ω–∞—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å`;
        statusDiv.style.background = '#d4edda';
        indicator.classList.add('active');
        addMessage(`üîí –¢—ã –≤ –∑–∞–∫—Ä—ã—Ç–æ–π –∫–æ–º–Ω–∞—Ç–µ #${room}. –¢–æ–ª—å–∫–æ –∑–Ω–∞—é—â–∏–µ –∫–ª—é—á –∏ –Ω–æ–º–µ—Ä ‚Äî —É–≤–∏–¥—è—Ç —á—Ç–æ-–ª–∏–±–æ.`);
    };

    // –û—Ç–ø—Ä–∞–≤–∫–∞
    async function send() {
        if (participantCount >= maxAllowed) return alert('–ö–æ–º–Ω–∞—Ç–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞!');
        const text = messageInput.value.trim();
        if (!text) return;
        const payload = await encrypt(`${nickname}: ${text}`);
        client.publish(currentTopic, payload);
        addMessage(`${nickname}: ${text}`, true);
        messageInput.value = '';
    }
    sendButton.onclick = send;
    messageInput.onkeydown = e => { if(e.key==='Enter') send(); };

    // –ü—Ä–∏—ë–º
    async function addMessage(text, isOwn = false) {
        const div = document.createElement('div');
        div.className = 'msg' + (isOwn ? ' my' : '');
        div.textContent = await decrypt(text);
        if (text.startsWith('ENC:')) div.style.borderLeft = '4px solid #28a745';
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    client.on('message', async (topic, msg) => {
        if (topic !== currentTopic) return;
        const payload = msg.toString();

        if (payload.startsWith('JOIN:')) {
            participantCount++;
            if (participantCount > maxAllowed) {
                warningDiv.textContent = '‚ö† –ö–æ–º–Ω–∞—Ç–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞! –ù–æ–≤—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–µ –≤–∏–¥—è—Ç —Å–æ–æ–±—â–µ–Ω–∏—è.';
                warningDiv.style.display = 'block';
            }
            statusDiv.textContent = `–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${participantCount}/${maxAllowed}`;
            return;
        }

        if (payload.startsWith('ENC:')) {
            await addMessage(payload);
        }
    });

    client.on('connect', () => statusDiv.textContent += ' ‚Ä¢ MQTT –≥–æ—Ç–æ–≤');

    window.onload = () => generateRoomBtn.click();
</script>
</body>
</html>
