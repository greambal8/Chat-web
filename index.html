<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîí –ó–∞—â–∏—â—ë–Ω–Ω—ã–π –ß–∞—Ç ‚Ä¢ Web Crypto API AES-256-GCM ‚Ä¢ 100% –†–∞–±–æ—Ç–∞–µ—Ç</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body {font-family:'Roboto',sans-serif;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);margin:0;padding:20px;height:100vh;display:flex;justify-content:center;align-items:flex-start;color:#333;}
        #chat-container {width:480px;max-width:95%;background:#fff;border-radius:20px;box-shadow:0 15px 35px rgba(0,0,0,0.15);overflow:hidden;margin-top:20px;}
        #messages {height:420px;overflow-y:auto;padding:20px;background:#f8f9fa;}
        .msg {margin-bottom:14px;padding:12px 18px;border-radius:20px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.06);max-width:85%;word-wrap:break-word;animation:fadeIn .3s ease;}
        .my {align-self:flex-end;background:#007bff !important;color:#fff;}
        @keyframes fadeIn {from{opacity:0;transform:translateY(10px)}to{opacity:1}}

        #encryption-panel {padding:12px 15px;background:#e9f7ef;border-bottom:1px solid #c3e6cb;display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
        #encryption-panel input {flex:1;min-width:200px;padding:10px;border:1px solid #ced4da;border-radius:10px;font-family:monospace;font-size:14px;}
        #encryption-panel button {padding:10px 16px;border:none;border-radius:10px;cursor:pointer;font-weight:500;}
        #use-key {background:#28a745;color:#fff;}
        #use-key.active {background:#1e7e34;}
        #deactivate-key {background:#dc3545;color:#fff;}
        #generate-key {background:#ffc107;color:#212529;}

        #input-container {display:flex;padding:15px;background:#f8f9fa;border-top:1px solid #e9ecef;gap:10px;align-items:center;}
        #message-input {flex:1;padding:12px;border:1px solid #ced4da;border-radius:10px;font-size:16px;}
        #send-button {position:relative;padding:12px 24px;background:#28a745;color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:500;}
        #encryption-indicator {position:absolute;top:-10px;right:-10px;width:28px;height:28px;display:none;opacity:0.9;}
        #encryption-indicator.active {display:block;}

        #clear-button {margin:0 15px 15px;padding:12px;background:#dc3545;color:#fff;border:none;border-radius:10px;cursor:pointer;width:calc(100% - 30px);}
        #status {padding:10px;text-align:center;background:#e9ecef;font-size:14px;}
    </style>
</head>
<body>

<div id="chat-container">
    <div id="encryption-panel">
        <input type="text" id="aes-key-input" placeholder="AES-256 –∫–ª—é—á (64 hex —Å–∏–º–≤–æ–ª–∞)" maxlength="64">
        <button id="use-key">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á</button>
        <button id="deactivate-key" style="display:none">–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="generate-key">üîë –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
    </div>

    <div id="messages"></div>

    <div id="input-container">
        <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="send-button">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            <img src="Encripted.png" id="encryption-indicator" alt="üîí">
        </button>
    </div>

    <button id="clear-button">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
    <div id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
</div>

<script>
    const topic = 'greambal8-secure-chat-v4';
    const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');

    const messagesDiv      = document.getElementById('messages');
    const messageInput     = document.getElementById('message-input');
    const sendButton       = document.getElementById('send-button');
    const statusDiv        = document.getElementById('status');
    const aesKeyInput      = document.getElementById('aes-key-input');
    const useKeyBtn        = document.getElementById('use-key');
    const deactivateKeyBtn = document.getElementById('deactivate-key');
    const generateKeyBtn   = document.getElementById('generate-key');
    const indicator        = document.getElementById('encryption-indicator');

    let nickname = localStorage.getItem('chat-nickname') || 'User_' + Math.floor(Math.random()*9999);
    localStorage.setItem('chat-nickname', nickname);

    let encryptionEnabled = false;
    let cryptoKey = null; // –Ω–∞—Ç–∏–≤–Ω—ã–π CryptoKey

    // ====================== Web Crypto API ‚Äî AES-256-GCM ======================
    async function importKey(hexKey) {
        const rawKey = hexToArrayBuffer(hexKey);
        return await crypto.subtle.importKey(
            "raw",
            rawKey,
            { name: "AES-GCM" },
            false,
            ["encrypt", "decrypt"]
        );
    }

    async function encryptMessage(message) {
        if (!encryptionEnabled) return message;

        const encoder = new TextEncoder();
        const data = encoder.encode(message);
        const iv = crypto.getRandomValues(new Uint8Array(12));

        const ciphertext = await crypto.subtle.encrypt(
            { name: "AES-GCM", iv: iv },
            cryptoKey,
            data
        );

        // –§–æ—Ä–º–∞—Ç: ENC:base64(iv + ciphertext)
        const combined = new Uint8Array(iv.byteLength + ciphertext.byteLength);
        combined.set(iv, 0);
        combined.set(new Uint8Array(ciphertext), iv.byteLength);

        return 'ENC:' + btoa(String.fromCharCode(...combined));
    }

    async function decryptMessage(b64data) {
        if (!encryptionEnabled || !b64data.startsWith('ENC:')) return b64data;

        try {
            const combined = Uint8Array.from(atob(b64data.slice(4)), c => c.charCodeAt(0));
            const iv = combined.slice(0, 12);
            const ciphertext = combined.slice(12);

            const decrypted = await crypto.subtle.decrypt(
                { name: "AES-GCM", iv: iv },
                cryptoKey,
                ciphertext
            );

            return new TextDecoder().decode(decrypted);
        } catch (e) {
            return "üîì [–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ ‚Äî –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á]";
        }
    }

    function hexToArrayBuffer(hex) {
        const bytes = new Uint8Array(hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
        return bytes.buffer;
    }

    // ====================== –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ ======================
    generateKeyBtn.onclick = async () => {
        const key = crypto.getRandomValues(new Uint8Array(32));
        const hex = Array.from(key).map(b => b.toString(16).padStart(2, '0')).join('');
        aesKeyInput.value = hex;
        alert('–ö–ª—é—á AES-256 —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!\n–°–∫–æ–ø–∏—Ä—É–π –∏ –ø–µ—Ä–µ–¥–∞–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º.');
    };

    // ====================== –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–ª—é—á–∞ ======================
    useKeyBtn.onclick = async () => {
        const hex = aesKeyInput.value.trim();
        if (!/^[0-9a-fA-F]{64}$/.test(hex)) {
            alert('–û—à–∏–±–∫–∞: –∫–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–æ–≤–Ω–æ 64 hex-—Å–∏–º–≤–æ–ª–∞!');
            return;
        }

        try {
            cryptoKey = await importKey(hex);
            encryptionEnabled = true;

            useKeyBtn.classList.add('active');
            useKeyBtn.textContent = '–ö–ª—é—á –∞–∫—Ç–∏–≤–µ–Ω ‚úì';
            deactivateKeyBtn.style.display = 'inline-block';
            indicator.classList.add('active');
            statusDiv.textContent = 'üîí –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ AES-256-GCM –∞–∫—Ç–∏–≤–Ω–æ (Web Crypto API)';
            statusDiv.style.color = '#28a745';
        } catch (e) {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á');
        }
    };

    deactivateKeyBtn.onclick = () => {
        encryptionEnabled = false;
        cryptoKey = null;
        useKeyBtn.classList.remove('active');
        useKeyBtn.textContent = '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á';
        deactivateKeyBtn.style.display = 'none';
        indicator.classList.remove('active');
        statusDiv.textContent = '–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ';
        statusDiv.style.color = '#6c757d';
    };

    // ====================== –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ======================
    async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text) return;

        const full = `${nickname}: ${text}`;
        const payload = encryptionEnabled ? await encryptMessage(full) : full;

        client.publish(topic, payload);
        addMessage(full, true);
        messageInput.value = '';
    }

    sendButton.onclick = sendMessage;
    messageInput.onkeydown = e => { if (e.key === 'Enter') sendMessage(); };

    // ====================== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç ======================
    async function addMessage(text, isOwn = false) {
        const div = document.createElement('div');
        div.className = 'msg' + (isOwn ? ' my' : '');

        const decrypted = encryptionEnabled ? await decryptMessage(text) : text;
        div.textContent = decrypted;

        if (text.startsWith('ENC:')) {
            div.style.borderLeft = '4px solid #28a745';
            div.style.background = isOwn ? '#0056b3' : '#e8f5e9';
        }

        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // ====================== MQTT ======================
    client.on('connect', () => {
        statusDiv.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ! –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.';
        statusDiv.style.color = '#28a745';
        client.subscribe(topic);
    });

    client.on('message', async (_, msg) => {
        await addMessage(msg.toString());
    });

    // –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞
    document.getElementById('clear-button').onclick = () => {
        if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —á–∞—Ç?')) messagesDiv.innerHTML = '';
    };

    // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    window.onload = () => {
        addMessage(`–ü—Ä–∏–≤–µ—Ç, ${nickname}! –ß–∞—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.\n–î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∏–ª–∏ –≤—Å—Ç–∞–≤—å –∫–ª—é—á ‚Üí "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á".`);
    };
</script>
</body>
</html>
